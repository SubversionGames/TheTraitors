<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player - Subversion: The Traitors</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-interface">
        <!-- Top Bar with Timer -->
        <div class="top-bar">
            <div class="player-info">
                <span id="player-name-display">Player</span>
                <span id="player-seat-display" style="margin-left: 15px; color: #bbb;">No Seat</span>
            </div>

            <div class="timer-display">
                <div class="phase-name" id="phase-name">Waiting to Start</div>
                <div class="timer" id="timer">00:00</div>
            </div>

            <div class="player-controls">
                <button onclick="toggleHandRaise()" class="control-button" id="hand-raise-btn">
                    ü§ö Raise Hand
                </button>
                <button onclick="toggleMute()" class="control-button" id="mute-btn">
                    üîá Mute
                </button>
                <button onclick="toggleVideo()" class="control-button" id="video-btn">
                    üìπ Video Off
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Video Circle -->
            <div class="video-circle-container">
                <div class="video-circle" id="video-circle">
                    <!-- Seat 1 (Host) - Top Left -->
                    <div class="video-seat host" id="seat-1" style="top: 1%; left: 1%; transform: none;">
                        <div id="video-1"></div>
                        <div class="seat-label">
                            <span class="seat-number">Seat 1</span>
                            <span class="player-name" id="name-1">Host</span>
                        </div>
                    </div>

                    <!-- Player Seats 2-25 will be generated by JavaScript -->
                </div>

                <!-- Announcement Display -->
                <div id="announcement-overlay" class="announcement-overlay"></div>
            </div>

            <!-- Room Selection Panel (appears during Talk phase) -->
            <div class="room-panel" id="room-panel">
                <h3>Select a Room</h3>
                <div class="room-list" id="room-list">
                    <div class="room-item" onclick="joinRoom('main')">
                        <div class="room-name">Main Roundtable</div>
                        <div class="room-count" id="count-main">0/24</div>
                    </div>
                    <div class="room-item" onclick="joinRoom('kitchen')">
                        <div class="room-name">Kitchen</div>
                        <div class="room-count" id="count-kitchen">0/5</div>
                    </div>
                    <div class="room-item" onclick="joinRoom('library')">
                        <div class="room-name">Library</div>
                        <div class="room-count" id="count-library">0/5</div>
                    </div>
                    <div class="room-item" onclick="joinRoom('living')">
                        <div class="room-name">Living Room</div>
                        <div class="room-count" id="count-living">0/5</div>
                    </div>
                    <div class="room-item" onclick="joinRoom('courtyard')">
                        <div class="room-name">Courtyard</div>
                        <div class="room-count" id="count-courtyard">0/5</div>
                    </div>
                    <div class="room-item" onclick="joinRoom('bathroom')">
                        <div class="room-name">Bathroom</div>
                        <div class="room-count" id="count-bathroom">0/3</div>
                    </div>
                    <div class="room-item" onclick="joinRoom('gym')">
                        <div class="room-name">Gym</div>
                        <div class="room-count" id="count-gym">0/5</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Night Overlay -->
    <div class="overlay-screen" id="night-overlay">
        <div class="overlay-message">The Traitors Are Meeting In The Turret...</div>
    </div>

    <!-- Seat Selection Modal -->
    <div class="modal visible" id="seat-selection-modal">
        <div class="modal-content">
            <h2>Welcome!</h2>
            <p>Click on an empty seat to join the game.</p>
            <p style="font-size: 0.9rem; color: #bbb;">Waiting for game to start...</p>
        </div>
    </div>

    <!-- Voting Modal -->
    <div class="modal" id="voting-modal">
        <div class="modal-content">
            <h2>Cast Your Vote</h2>
            <p>Click on a player's name below their seat to vote for them.</p>
            <p id="your-vote-display" style="margin-top: 15px; font-weight: bold; color: #4CAF50;"></p>
            <div class="modal-buttons">
                <button onclick="closeVotingModal()" class="control-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Reveal Vote Instructions -->
    <div class="modal" id="reveal-modal">
        <div class="modal-content">
            <h2>Your Turn to Reveal</h2>
            <p style="font-size: 1.2rem; margin: 20px 0;">Press <strong>SPACE BAR</strong> to reveal your vote</p>
            <p style="color: #bbb;">You voted for: <span id="reveal-vote-name" style="color: #fff; font-weight: bold;"></span></p>
        </div>
    </div>

    <!-- Turret Invitation Modal -->
    <div class="modal" id="turret-invite-modal">
        <div class="modal-content">
            <h2>üè∞ You've Been Invited to the Turret</h2>
            <p>The host has invited you to join a private meeting.</p>
            <div class="modal-buttons">
                <button onclick="acceptTurretInvite()" class="control-button primary">Join Turret</button>
            </div>
        </div>
    </div>

    <!-- Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Jitsi Meet API -->
    <script src="https://meet.jit.si/external_api.js"></script>

    <!-- Game Logic -->
    <script src="game.js"></script>
    <script src="agora-integration.js"></script>

    <!-- Player-Specific Logic -->
    <script>
        // Check if user is authorized
        if (sessionStorage.getItem('userRole') !== 'player') {
            alert('Unauthorized access');
            window.location.href = 'index.html';
        }

        // Player-specific state
        let hasRaisedHand = false;
        let isMuted = false;
        let isVideoOff = false;
        let myVote = null;

        // Update player info display
        function updatePlayerDisplay() {
            const name = sessionStorage.getItem('playerName') || currentUser.name;
            const seat = sessionStorage.getItem('playerSeat') || currentUser.seat;
            
            if (name) {
                document.getElementById('player-name-display').textContent = name;
            }
            
            if (seat) {
                document.getElementById('player-seat-display').textContent = `Seat ${seat}`;
            }
        }

        // Hand raise toggle
        function toggleHandRaise() {
            hasRaisedHand = !hasRaisedHand;
            const btn = document.getElementById('hand-raise-btn');
            
            if (hasRaisedHand) {
                btn.textContent = '‚úã Hand Raised';
                btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                // Update in Firebase
                database.ref('players/' + currentUser.id + '/handRaised').set(true);
            } else {
                btn.textContent = 'ü§ö Raise Hand';
                btn.style.background = 'rgba(255, 255, 255, 0.2)';
                database.ref('players/' + currentUser.id + '/handRaised').set(false);
            }
        }

        // Mute toggle
        async function toggleMute() {
            const isMuted = await toggleAudio();
            const btn = document.getElementById('mute-btn');
            
            if (isMuted) {
                btn.textContent = 'üîá Unmute';
                btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            } else {
                btn.textContent = 'üîá Mute';
                btn.style.background = 'rgba(255, 255, 255, 0.2)';
            }
        }

        // Video toggle
        async function toggleVideo() {
            const isVideoOff = await toggleVideo();
            const btn = document.getElementById('video-btn');
            
            if (isVideoOff) {
                btn.textContent = 'üìπ Video On';
                btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            } else {
                btn.textContent = 'üìπ Video Off';
                btn.style.background = 'rgba(255, 255, 255, 0.2)';
            }
        }

        // Room selection
        function joinRoom(roomId) {
            // Check room limits
            database.ref('game/roomLimits/' + roomId).once('value', (snapshot) => {
                const limit = snapshot.val() || 24;
                
                // Count current players in room
                database.ref('players').once('value', (playersSnapshot) => {
                    let count = 0;
                    playersSnapshot.forEach((child) => {
                        if (child.val().room === roomId) count++;
                    });
                    
                    if (count >= limit) {
                        alert('This room is full. Please choose another room.');
                        return;
                    }
                    
                    // Join room
                    database.ref('players/' + currentUser.id + '/room').set(roomId);
                    currentUser.room = roomId;
                    
                    // Hide room panel
                    document.getElementById('room-panel').style.display = 'none';
                });
            });
        }

        // Show room panel during Talk phase
        database.ref('game/phase').on('value', (snapshot) => {
            const phase = snapshot.val();
            const roomPanel = document.getElementById('room-panel');
            
            if (phase === 'talk' && currentUser.seat) {
                roomPanel.style.display = 'block';
            } else {
                roomPanel.style.display = 'none';
            }
        });

        // Listen for turret invitations
        database.ref('players/' + currentUser.id + '/turretInvited').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                document.getElementById('turret-invite-modal').classList.add('visible');
            }
        });

        function acceptTurretInvite() {
            document.getElementById('turret-invite-modal').classList.remove('visible');
            // Night overlay will be hidden by game.js when room changes to turret
        }

        // Voting
        function closeVotingModal() {
            document.getElementById('voting-modal').classList.remove('visible');
        }

        // Listen for voting phase
        database.ref('game/voting').on('value', (snapshot) => {
            const voting = snapshot.val();
            if (voting && voting.active && !voting.votingLocked) {
                document.getElementById('voting-modal').classList.add('visible');
            } else {
                document.getElementById('voting-modal').classList.remove('visible');
            }
            
            // Check if it's my turn to reveal
            if (voting && voting.revealed && voting.currentRevealer === currentUser.id) {
                // Show reveal modal
                database.ref('game/voting/votes/' + currentUser.id).once('value', (voteSnap) => {
                    const votedSeat = voteSnap.val();
                    if (votedSeat) {
                        const player = Object.values(gameState.players).find(p => p.seat === votedSeat);
                        document.getElementById('reveal-vote-name').textContent = player ? player.name : `Seat ${votedSeat}`;
                        document.getElementById('reveal-modal').classList.add('visible');
                    }
                });
            } else {
                document.getElementById('reveal-modal').classList.remove('visible');
            }
        });

        // Listen for seat selection being enabled
        database.ref('game/phase').on('value', (snapshot) => {
            const phase = snapshot.val();
            const modal = document.getElementById('seat-selection-modal');
            
            if (phase === 'lobby' && !currentUser.seat) {
                modal.classList.add('visible');
                modal.querySelector('p:last-child').textContent = 'Click an empty seat to join!';
            } else {
                modal.classList.remove('visible');
            }
        });
        
        // Also hide modal when seat is claimed
        database.ref('players/' + currentUser.id + '/seat').on('value', (snapshot) => {
            if (snapshot.val()) {
                document.getElementById('seat-selection-modal').classList.remove('visible');
            }
        });

        // Initialize
        updatePlayerDisplay();
        
        // Update display when player claims seat
        database.ref('players/' + currentUser.id).on('value', (snapshot) => {
            const playerData = snapshot.val();
            if (playerData && playerData.seat) {
                currentUser.seat = playerData.seat;
                currentUser.name = playerData.name;
                sessionStorage.setItem('playerSeat', playerData.seat);
                sessionStorage.setItem('playerName', playerData.name);
                updatePlayerDisplay();
            }
        });
    </script>
</body>
</html>
