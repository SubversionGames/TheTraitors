<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host - Subversion: The Traitors</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-interface">
        <!-- Top Bar with Timer and Controls -->
        <div class="top-bar">
            <div class="host-info">
                <span id="host-mode-display">Main Host</span>
                <button onclick="toggleProductionMode()" class="control-button" id="production-toggle">
                    Switch to Production Viewer
                </button>
                <button onclick="toggleHostVideo()" class="control-button" id="host-video-btn">
                    Video On
                </button>
                <button onclick="toggleHostAudio()" class="control-button" id="host-audio-btn">
                    Mic On
                </button>
            </div>

            <div class="timer-display">
                <div class="phase-name" id="phase-name">Waiting to Start</div>
                <div class="timer" id="timer">00:00</div>
            </div>

            <div class="host-controls">
                <button onclick="startGame()" class="control-button success" id="start-game-btn">
                    Start Game
                </button>
                <button onclick="setTimer()" class="control-button">
                    Set Timer
                </button>
                <button onclick="startTimer()" class="control-button" id="start-timer-btn" disabled>
                    Start Timer
                </button>
                <button onclick="pauseTimer()" class="control-button" id="pause-timer-btn" disabled>
                    Pause Timer
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Video Circle -->
            <div class="video-circle-container">
                <!-- Host Seat - Double size, centered in player area -->
                <div class="video-seat host" id="seat-1">
                    <div id="video-1"></div>
                    <div class="seat-label" style="position: absolute; top: calc(100% + 5px); left: 50%; transform: translateX(-50%); white-space: nowrap; z-index: 100;">
                        <span class="player-name" id="name-1" style="cursor: pointer; font-weight: bold; font-size: 0.9rem; color: white;">Host</span>
                    </div>
                </div>
            
                <div class="video-circle" id="video-circle">
                    <!-- Player Seats 2-25 will be generated by JavaScript -->
                </div>
            </div>

            <!-- Tab System (Right Side) -->
            <div class="tab-container">
                <!-- Tab Buttons -->
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('game-controls')">Game Controls</button>
                    <button class="tab-button" onclick="switchTab('rooms')">Rooms</button>
                    <button class="tab-button" onclick="switchTab('vote-count')">Vote Count</button>
                    <button class="tab-button" onclick="switchTab('waiting-lobby')">Waiting Room</button>
                    <button class="tab-button" onclick="switchTab('viewers')">Viewers</button>
                    <button class="tab-button" onclick="switchTab('turret')">Turret</button>
                </div>
                
                <!-- Tab Content Panel -->
                <div class="tab-content-panel" id="tab-panel">
                    <!-- Game Controls Tab -->
                    <div class="tab-content active" id="game-controls">
                        <h3>Game Controls</h3>
                        
                        <!-- Phase Controls -->
                        <div class="control-section">
                            <h4>Phase Control</h4>
                            <button onclick="setPhase('breakfast')" class="control-button" style="width: 100%; margin-bottom: 10px;">
                                Begin Breakfast
                            </button>
                            <button onclick="setPhase('talk')" class="control-button" style="width: 100%; margin-bottom: 10px;">
                                Talk Phase
                            </button>
                            <button onclick="setPhase('deliberation')" class="control-button" style="width: 100%; margin-bottom: 10px;">
                                Deliberation
                            </button>
                            <button onclick="setPhase('night')" class="control-button danger" style="width: 100%; margin-bottom: 10px;">
                                Go To Night
                            </button>
                        </div>
    
                        <!-- Voting Controls -->
                        <div class="control-section">
                            <h4>Voting</h4>
                            <button onclick="startVoting()" class="control-button primary" style="width: 100%; margin-bottom: 10px;">
                                Start Vote
                            </button>
                            <button onclick="revealVotes()" class="control-button" style="width: 100%; margin-bottom: 10px;" id="reveal-votes-btn" disabled>
                                Reveal Votes
                            </button>
                            <button onclick="selectFirstRevealer()" class="control-button" style="width: 100%; margin-bottom: 10px;" id="select-revealer-btn" disabled>
                                Select First Revealer
                            </button>
                        </div>
    
                        <!-- Circle of Truth -->
                        <div class="control-section">
                            <h4>Circle of Truth</h4>
                            <button onclick="selectForCircleOfTruth()" class="control-button danger" style="width: 100%; margin-bottom: 10px;">
                                Select Player
                            </button>
                            <button onclick="makeGhost()" class="control-button" style="width: 100%; margin-bottom: 10px;" id="make-ghost-btn" disabled>
                                Make Ghost
                            </button>
                        </div>
    
                        <!-- Room Limits -->
                        <div class="control-section">
                            <h4>Room Limits</h4>
                            <div style="font-size: 0.85rem; color: #bbb;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="flex: 1;">Main:</span>
                                    <button onclick="adjustLimit('main', -1)" class="limit-btn">âˆ’</button>
                                    <input type="number" id="limit-main" value="24" min="1" max="30" style="width: 50px; text-align: center; margin: 0 5px;">
                                    <button onclick="adjustLimit('main', 1)" class="limit-btn">+</button>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="flex: 1;">Kitchen:</span>
                                    <button onclick="adjustLimit('kitchen', -1)" class="limit-btn">âˆ’</button>
                                    <input type="number" id="limit-kitchen" value="5" min="1" max="15" style="width: 50px; text-align: center; margin: 0 5px;">
                                    <button onclick="adjustLimit('kitchen', 1)" class="limit-btn">+</button>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="flex: 1;">Library:</span>
                                    <button onclick="adjustLimit('library', -1)" class="limit-btn">âˆ’</button>
                                    <input type="number" id="limit-library" value="5" min="1" max="15" style="width: 50px; text-align: center; margin: 0 5px;">
                                    <button onclick="adjustLimit('library', 1)" class="limit-btn">+</button>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="flex: 1;">Living Room:</span>
                                    <button onclick="adjustLimit('living', -1)" class="limit-btn">âˆ’</button>
                                    <input type="number" id="limit-living" value="5" min="1" max="15" style="width: 50px; text-align: center; margin: 0 5px;">
                                    <button onclick="adjustLimit('living', 1)" class="limit-btn">+</button>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="flex: 1;">Courtyard:</span>
                                    <button onclick="adjustLimit('courtyard', -1)" class="limit-btn">âˆ’</button>
                                    <input type="number" id="limit-courtyard" value="5" min="1" max="15" style="width: 50px; text-align: center; margin: 0 5px;">
                                    <button onclick="adjustLimit('courtyard', 1)" class="limit-btn">+</button>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="flex: 1;">Bathroom:</span>
                                    <button onclick="adjustLimit('bathroom', -1)" class="limit-btn">âˆ’</button>
                                    <input type="number" id="limit-bathroom" value="3" min="1" max="10" style="width: 50px; text-align: center; margin: 0 5px;">
                                    <button onclick="adjustLimit('bathroom', 1)" class="limit-btn">+</button>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="flex: 1;">Gym:</span>
                                    <button onclick="adjustLimit('gym', -1)" class="limit-btn">âˆ’</button>
                                    <input type="number" id="limit-gym" value="5" min="1" max="15" style="width: 50px; text-align: center; margin: 0 5px;">
                                    <button onclick="adjustLimit('gym', 1)" class="limit-btn">+</button>
                                </div>
                            </div>
                            <button onclick="saveRoomLimits()" class="control-button" style="width: 100%; margin-top: 10px;">
                                Save Limits
                            </button>
                        </div>
    
                        <!-- Announcement -->
                        <div class="control-section">
                            <h4>Announcement</h4>
                            <textarea id="announcement-text" placeholder="Type announcement..." style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); min-height: 60px;"></textarea>
                            <button onclick="sendAnnouncement()" class="control-button primary" style="width: 100%;">
                                Send to All Rooms
                            </button>
                        </div>
                    </div>
    
                    <!-- Rooms Tab -->
                    <div class="tab-content" id="rooms">
                        <h3>Travel to Room</h3>
                        <div class="room-list">
                            <div class="room-item" onclick="hostJoinRoom('main')">
                                <div class="room-name">
                                    <span>Main Roundtable</span>
                                    <span class="room-count" id="host-count-main">0/24</span>
                                </div>
                                <div class="room-players" id="players-main"></div>
                            </div>
                            <div class="room-item" onclick="hostJoinRoom('kitchen')">
                                <div class="room-name">
                                    <span>Kitchen</span>
                                    <span class="room-count" id="host-count-kitchen">0/5</span>
                                </div>
                                <div class="room-players" id="players-kitchen"></div>
                            </div>
                            <div class="room-item" onclick="hostJoinRoom('library')">
                                <div class="room-name">
                                    <span>Library</span>
                                    <span class="room-count" id="host-count-library">0/5</span>
                                </div>
                                <div class="room-players" id="players-library"></div>
                            </div>
                            <div class="room-item" onclick="hostJoinRoom('living')">
                                <div class="room-name">
                                    <span>Living Room</span>
                                    <span class="room-count" id="host-count-living">0/5</span>
                                </div>
                                <div class="room-players" id="players-living"></div>
                            </div>
                            <div class="room-item" onclick="hostJoinRoom('courtyard')">
                                <div class="room-name">
                                    <span>Courtyard</span>
                                    <span class="room-count" id="host-count-courtyard">0/5</span>
                                </div>
                                <div class="room-players" id="players-courtyard"></div>
                            </div>
                            <div class="room-item" onclick="hostJoinRoom('bathroom')">
                                <div class="room-name">
                                    <span>Bathroom</span>
                                    <span class="room-count" id="host-count-bathroom">0/3</span>
                                </div>
                                <div class="room-players" id="players-bathroom"></div>
                            </div>
                            <div class="room-item" onclick="hostJoinRoom('gym')">
                                <div class="room-name">
                                    <span>Gym</span>
                                    <span class="room-count" id="host-count-gym">0/5</span>
                                </div>
                                <div class="room-players" id="players-gym"></div>
                            </div>
                            <div class="room-item" onclick="hostJoinRoom('turret')">
                                <div class="room-name">
                                    <span>Turret</span>
                                    <span class="room-count" id="host-count-turret">0/10</span>
                                </div>
                                <div class="room-players" id="players-turret"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                            <strong>Current Room:</strong> <span id="host-current-room">Main Roundtable</span>
                        </div>
                    </div>
    
                    <!-- Vote Count Tab -->
                    <div class="tab-content" id="vote-count">
                        <h3>Vote Count</h3>
                        <div class="floating-window-content" id="vote-tally-content">
                            <div style="color: #666;">No active votes</div>
                        </div>
                    </div>
    
                    <!-- Waiting Room Tab -->
                    <div class="tab-content" id="waiting-lobby">
                        <h3>Waiting Room</h3>
                        <div class="floating-window-content" id="lobby-list">
                            <div style="color: #666;">No players in lobby</div>
                        </div>
                    </div>
    
                    <!-- Viewers Tab -->
                    <div class="tab-content" id="viewers">
                        <h3>Viewers</h3>
                        <div class="floating-window-content" id="viewer-list">
                            <div style="color: #666;">No viewers connected</div>
                        </div>
                    </div>
    
                    <!-- Turret Tab -->
                    <div class="tab-content" id="turret">
                        <h3>Turret Controls</h3>
                        
                        <div class="control-section">
                            <h4>Invite Player</h4>
                            <button onclick="inviteToTurret()" class="control-button primary" style="width: 100%; margin-bottom: 10px;">
                                Select Player to Invite
                            </button>
                        </div>
    
                        <div class="control-section">
                            <h4>Players in Turret</h4>
                            <div id="turret-players-list" style="font-size: 0.85rem; color: #bbb; margin-bottom: 15px;">
                                None
                            </div>
                            <button onclick="clearTurret()" class="control-button danger" style="width: 100%;">
                                Send All to Lobby
                            </button>
                        </div>
    
                        <div class="control-section">
                            <h4>Turret Room</h4>
                            <button onclick="hostJoinRoom('turret')" class="control-button" style="width: 100%;">
                                Join Turret
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Set Timer Modal -->
    <div class="modal" id="timer-modal">
        <div class="modal-content">
            <h2>Set Timer</h2>
            <label>Minutes:</label>
            <input type="number" id="timer-minutes" min="0" max="60" value="10">
            <label>Seconds:</label>
            <input type="number" id="timer-seconds" min="0" max="59" value="0">
            <label>Phase Name:</label>
            <input type="text" id="timer-phase" placeholder="e.g., Talk Time" value="Talk Time">
            <div class="modal-buttons">
                <button onclick="closeTimerModal()" class="control-button">Cancel</button>
                <button onclick="confirmTimer()" class="control-button primary">Set</button>
            </div>
        </div>
    </div>

    <!-- Select Player Modal (for Circle of Truth, Turret, etc.) -->
    <div class="modal" id="select-player-modal">
        <div class="modal-content">
            <h2 id="select-player-title">Select Player</h2>
            <div id="player-selection-list"></div>
            <div class="modal-buttons">
                <button onclick="closeSelectPlayerModal()" class="control-button">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Agora SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Jitsi Meet API -->
    <script src="https://meet.jit.si/external_api.js"></script>

    <!-- Game Logic -->
    <script src="game.js"></script>
    <script src="agora-integration.js"></script>
    <script src="draggable-windows.js"></script> <!-- ADD THIS LINE -->

    <!-- Host-Specific Logic -->
    <script>
        // Check if user is authorized
        if (sessionStorage.getItem('userRole') !== 'host') {
            alert('Unauthorized access');
            window.location.href = 'index.html';
        }

        // CRITICAL: Auto-assign host to Seat 1 IMMEDIATELY before anything else
        currentUser.seat = 1;
        currentUser.name = 'Host';
        currentUser.id = 'host';
        sessionStorage.setItem('playerSeat', '1');
        sessionStorage.setItem('playerName', 'Host');
        console.log('Host assigned to Seat 1:', currentUser);

        // Register host in Firebase
        database.ref('players/host').set({
            id: 'host',
            name: 'Host',
            seat: 1,
            room: 'main',
            status: 'active',
            isHost: true,
            joinedAt: Date.now()
        });

        // Reset game state when host first loads
        database.ref('game/status').once('value', (snapshot) => {
            if (!snapshot.val() || snapshot.val() === 'started') {
                database.ref('game/status').set('waiting');
                database.ref('game/phase').set('waiting');
            }
        });

        // Allow host to rename themselves
        function renameHost() {
            const currentName = document.getElementById('name-1').textContent;
            const newName = prompt('Enter your name:', currentName);
            
            if (newName && newName.trim().length > 0) {
                const trimmedName = newName.trim().substring(0, 12);
                
                // Check for duplicate names
                database.ref('players').once('value', (snapshot) => {
                    let nameExists = false;
                    snapshot.forEach((child) => {
                        if (child.key !== 'host' && child.val().name === trimmedName) {
                            nameExists = true;
                        }
                    });
                    
                    if (nameExists) {
                        alert('This name is already taken. Please choose another.');
                        return;
                    }
                    
                    // Update name
                    document.getElementById('name-1').textContent = trimmedName;
                    database.ref('players/host/name').set(trimmedName);
                    currentUser.name = trimmedName;
                    sessionStorage.setItem('playerName', trimmedName);
                });
            }
        }

        // Add click handler to host name
        document.addEventListener('DOMContentLoaded', () => {
            const hostNameElement = document.getElementById('name-1');
            if (hostNameElement) {
                hostNameElement.addEventListener('click', renameHost);
            }
        });

        // Initialize host interface
        let isProduction = sessionStorage.getItem('isProduction') === 'true';
        
        function updateHostModeDisplay() {
            const display = document.getElementById('host-mode-display');
            const toggleBtn = document.getElementById('production-toggle');
            
            if (isProduction) {
                display.textContent = 'Production Mode';
                toggleBtn.textContent = 'Switch to Main Host';
            } else {
                display.textContent = 'Main Host';
                toggleBtn.textContent = 'Switch to Production';
            }
        }

        function toggleProductionMode() {
            // Check if Main Host is already active
            if (!isProduction) {
                // Switching to Production - check if someone else is Main Host
                database.ref('game/mainHostActive').once('value', (snapshot) => {
                    if (snapshot.val() && snapshot.val() !== sessionStorage.getItem('hostId')) {
                        alert('Someone else is currently Main Host. Only one Main Host allowed at a time.');
                        return;
                    }
                    
                    // Clear Main Host
                    database.ref('game/mainHostActive').set(null);
                    isProduction = true;
                    sessionStorage.setItem('isProduction', 'true');
                    updateHostModeDisplay();
                    // Hide video for this host
                    hideHostVideo();
                });
            } else {
                // Switching to Main Host - check if slot is available
                database.ref('game/mainHostActive').once('value', (snapshot) => {
                    if (snapshot.val() && snapshot.val() !== sessionStorage.getItem('hostId')) {
                        alert('Someone else is currently Main Host. Only one Main Host allowed at a time.');
                        return;
                    }
                    
                    // Claim Main Host
                    const hostId = sessionStorage.getItem('hostId') || 'host-' + Date.now();
                    sessionStorage.setItem('hostId', hostId);
                    database.ref('game/mainHostActive').set(hostId);
                    isProduction = false;
                    sessionStorage.setItem('isProduction', 'false');
                    updateHostModeDisplay();
                    // Show video for this host
                    showHostVideo();
                });
            }
        }

        function hideHostVideo() {
            // Will implement with Jitsi integration
            console.log('Hiding host video');
        }

        function showHostVideo() {
            // Will implement with Jitsi integration
            console.log('Showing host video');
        }

        // Host video/audio controls
        async function toggleHostVideo() {
            if (window.toggleVideo) {
                const isOff = await window.toggleVideo();
                const btn = document.getElementById('host-video-btn');
                if (isOff) {
                    btn.textContent = 'ðŸ“¹ Video Off';
                    btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                } else {
                    btn.textContent = 'ðŸ“¹ Video On';
                    btn.style.background = 'rgba(255, 255, 255, 0.2)';
                }
            }
        }

        // Position host seat in center of player area
        function updateHostPosition() {
            // Use calculated values from generateVideoSeats
            const centerX = window.seatingCenterX || window.innerWidth / 2;
            const centerY = window.seatingCenterY || window.innerHeight / 2;
            const hostSize = window.currentHostSize || 240;
            
            const hostSeat = document.getElementById('seat-1');
            if (hostSeat) {
                hostSeat.style.left = `${centerX}px`;
                hostSeat.style.top = `${centerY}px`;
                hostSeat.style.width = `${hostSize}px`;
                hostSeat.style.height = `${hostSize}px`;
                hostSeat.style.transform = 'translate(-50%, -50%)';
            }
            
            console.log(`Host positioned at seating center: x=${centerX}px, y=${centerY}px, size=${hostSize}px`);
        }

        // Call on load and resize
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateHostPosition, 100);
        });
        window.addEventListener('resize', () => {
            updateHostPosition();
        });

        // Resize host seat to match player seats
        function resizeHostSeat() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Same calculation as player seats
            const horizontalPadding = 300;
            const horizontalEndPadding = 100;
            const topMargin = 100;
            const bottomMargin = 100;
            const verticalGapFromCorner = 150;
            
            const availableWidth = viewportWidth - horizontalPadding - horizontalEndPadding;
            const availableHeight = viewportHeight - topMargin - bottomMargin - (verticalGapFromCorner * 2);
            
            const topSeats = 8;
            const maxSeatWidthFromTop = availableWidth / topSeats * 0.8;
            const sideSeats = 4;
            const maxSeatHeightFromSide = availableHeight / sideSeats * 0.8;
            
            const calculatedSeatSize = Math.min(maxSeatWidthFromTop, maxSeatHeightFromSide, 180);
            const seatSize = Math.max(100, calculatedSeatSize);
            
            // Update host seat size
            const hostSeat = document.getElementById('seat-1');
            if (hostSeat) {
                hostSeat.style.width = `${seatSize}px`;
                hostSeat.style.height = `${seatSize}px`;
            }
            
            // Update host name tag position (below seat)
            const hostNameTag = hostSeat.nextElementSibling;
            if (hostNameTag) {
                const hostTop = 100;
                hostNameTag.style.top = `${hostTop + seatSize/2 + 10}px`;
            }
        }

        // Call on load and resize
        window.addEventListener('load', resizeHostSeat);
        window.addEventListener('resize', () => {
            clearTimeout(window.hostResizeTimeout);
            window.hostResizeTimeout = setTimeout(resizeHostSeat, 250);
        });

        async function toggleHostAudio() {
            if (window.toggleAudio) {
                const isMuted = await window.toggleAudio();
                const btn = document.getElementById('host-audio-btn');
                if (isMuted) {
                    btn.textContent = 'ðŸŽ¤ Mic Off';
                    btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                } else {
                    btn.textContent = 'ðŸŽ¤ Mic On';
                    btn.style.background = 'rgba(255, 255, 255, 0.2)';
                }
            }
        }

        // Timer Modal Functions
        function setTimer() {
            document.getElementById('timer-modal').classList.add('visible');
        }

        function closeTimerModal() {
            document.getElementById('timer-modal').classList.remove('visible');
        }

        function confirmTimer() {
            const minutes = parseInt(document.getElementById('timer-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('timer-seconds').value) || 0;
            const phase = document.getElementById('timer-phase').value || 'Timer';
            
            const totalSeconds = (minutes * 60) + seconds;
            
            // Save to Firebase
            database.ref('game/timer').set({
                totalSeconds: totalSeconds,
                remainingSeconds: totalSeconds,
                phase: phase,
                isRunning: false
            });
            
            document.getElementById('start-timer-btn').disabled = false;
            closeTimerModal();
        }

        function startTimer() {
            database.ref('game/timer/isRunning').set(true);
            document.getElementById('start-timer-btn').disabled = true;
            document.getElementById('pause-timer-btn').disabled = false;
        }

        function pauseTimer() {
            database.ref('game/timer/isRunning').set(false);
            document.getElementById('start-timer-btn').disabled = false;
            document.getElementById('pause-timer-btn').disabled = true;
        }

        // Game Phase Functions
        function startGame() {
            console.log('Start Game clicked!');
            
            if (confirm('Start the game? This will allow players to select seats.')) {
                console.log('User confirmed, setting game status...');
                
                database.ref('game/status').set('started').then(() => {
                    console.log('Game status set to started');
                });
                
                database.ref('game/phase').set('lobby').then(() => {
                    console.log('Game phase set to lobby');
                });
                
                document.getElementById('start-game-btn').textContent = 'Game Started';
                document.getElementById('start-game-btn').disabled = true;
                alert('Game started! Players can now join and select seats.');
            } else {
                console.log('User cancelled');
            }
        }

        function setPhase(phase) {
            const phaseNames = {
                'breakfast': 'Breakfast',
                'talk': 'Talk Time',
                'deliberation': 'Deliberation',
                'night': 'Night'
            };
            
            database.ref('game/phase').set(phase);
            document.getElementById('phase-name').textContent = phaseNames[phase];
            
            // Special handling for night phase
            if (phase === 'night') {
                // Move all players to lobby
                database.ref('players').once('value', (snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        database.ref('players/' + childSnapshot.key + '/room').set('lobby');
                    });
                });
            }
        }

        // Voting Functions
        function startVoting() {
            if (confirm('Start voting? Players will select who to vote for.')) {
                database.ref('game/voting').set({
                    active: true,
                    revealed: false,
                    votes: {}
                });
                alert('Voting started! Players can now vote.');
            }
        }

        function revealVotes() {
            database.ref('game/voting/revealed').set(true);
            document.getElementById('select-revealer-btn').disabled = false;
        }

        function selectFirstRevealer() {
            // Open player selection modal
            openSelectPlayerModal('Select First Revealer', (playerId) => {
                database.ref('game/voting/currentRevealer').set(playerId);
                closeSelectPlayerModal();
            });
        }

        // Circle of Truth Functions
        let selectedForCircle = null;

        function selectForCircleOfTruth() {
            openSelectPlayerModal('Select Player for Circle of Truth', (playerId) => {
                selectedForCircle = playerId;
                database.ref('game/circleOfTruth').set({
                    playerId: playerId,
                    active: true
                });
                document.getElementById('make-ghost-btn').disabled = false;
                closeSelectPlayerModal();
            });
        }

        function makeGhost() {
            if (selectedForCircle) {
                if (confirm('Remove this player from the game and make them a ghost viewer?')) {
                    database.ref('players/' + selectedForCircle + '/status').set('ghost');
                    database.ref('players/' + selectedForCircle + '/room').set('none');
                    database.ref('game/circleOfTruth').set(null);
                    selectedForCircle = null;
                    document.getElementById('make-ghost-btn').disabled = true;
                }
            }
        }

        // Turret Functions
        function inviteToTurret() {
            openSelectPlayerModal('Invite to Turret', (playerId) => {
                database.ref('players/' + playerId + '/room').set('turret');
                database.ref('players/' + playerId + '/turretInvited').set(true);
                closeSelectPlayerModal();
                updateTurretList();
            });
        }

        function updateTurretList() {
            database.ref('players').once('value', (snapshot) => {
                const turretPlayers = [];
                snapshot.forEach((childSnapshot) => {
                    const player = childSnapshot.val();
                    if (player.room === 'turret') {
                        turretPlayers.push(player.name);
                    }
                });
                
                const turretDiv = document.getElementById('turret-players');
                if (turretPlayers.length === 0) {
                    turretDiv.textContent = 'None';
                } else {
                    turretDiv.textContent = turretPlayers.join(', ');
                }
            });
        }

        // Room Limits
        function saveRoomLimits() {
            const limits = {
                main: parseInt(document.getElementById('limit-main').value),
                kitchen: parseInt(document.getElementById('limit-kitchen').value),
                library: parseInt(document.getElementById('limit-library').value),
                living: parseInt(document.getElementById('limit-living').value),
                courtyard: parseInt(document.getElementById('limit-courtyard').value),
                bathroom: parseInt(document.getElementById('limit-bathroom').value),
                gym: parseInt(document.getElementById('limit-gym').value)
            };
            
            database.ref('game/roomLimits').set(limits);
            alert('Room limits saved!');
        }

        function adjustLimit(room, delta) {
            const input = document.getElementById(`limit-${room}`);
            const currentValue = parseInt(input.value);
            const newValue = Math.max(parseInt(input.min), Math.min(parseInt(input.max), currentValue + delta));
            input.value = newValue;
        }

        // Announcements
        function sendAnnouncement() {
            const text = document.getElementById('announcement-text').value.trim();
            if (text.length === 0) {
                alert('Please enter an announcement');
                return;
            }
            
            database.ref('game/announcement').set({
                text: text,
                timestamp: Date.now()
            });
            
            document.getElementById('announcement-text').value = '';
            alert('Announcement sent to all rooms!');
        }

        // Player Selection Modal
        function openSelectPlayerModal(title, callback) {
            document.getElementById('select-player-title').textContent = title;
            const list = document.getElementById('player-selection-list');
            list.innerHTML = '';
            
            database.ref('players').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const player = childSnapshot.val();
                    if (player.status !== 'ghost' && player.seat) {
                        const btn = document.createElement('button');
                        btn.textContent = `Seat ${player.seat} - ${player.name}`;
                        btn.className = 'control-button';
                        btn.style.width = '100%';
                        btn.style.marginBottom = '10px';
                        btn.onclick = () => callback(childSnapshot.key);
                        list.appendChild(btn);
                    }
                });
            });
            
            document.getElementById('select-player-modal').classList.add('visible');
        }

        function closeSelectPlayerModal() {
            document.getElementById('select-player-modal').classList.remove('visible');
        }

        // Initialize
        updateHostModeDisplay();
        
        // Register host in Firebase
        database.ref('players/host').set({
            id: 'host',
            name: 'Host',
            seat: 1,
            room: 'main',
            status: 'active',
            isHost: true,
            joinedAt: Date.now()
        });
        
        // Listen for timer updates
        database.ref('game/timer').on('value', (snapshot) => {
            const timer = snapshot.val();
            if (timer) {
                document.getElementById('phase-name').textContent = timer.phase;
                const mins = Math.floor(timer.remainingSeconds / 60);
                const secs = timer.remainingSeconds % 60;
                document.getElementById('timer').textContent = 
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
        });

        // Tab System
        function switchTab(tabId) {
            // Get panel
            const panel = document.getElementById('tab-panel');
            
            // Check if clicking the active tab (to close)
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab && currentTab.id === tabId && panel.classList.contains('open')) {
                // Close the panel
                panel.classList.remove('open');
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                return;
            }
            
            // Open panel if closed
            if (!panel.classList.contains('open')) {
                panel.classList.add('open');
            }
            
            // Update active tab button
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        // Initialize - start with panel closed
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.getElementById('tab-panel');
            if (panel) {
                panel.classList.add('open'); // Start with Game Controls open
            }
        });

        // Host room travel
        function hostJoinRoom(roomId) {
            database.ref('players/host/room').set(roomId);
            const roomNames = {
                'main': 'Main Roundtable',
                'kitchen': 'Kitchen',
                'library': 'Library',
                'living': 'Living Room',
                'courtyard': 'Courtyard',
                'bathroom': 'Bathroom',
                'gym': 'Gym',
                'turret': 'Turret'
            };
            document.getElementById('host-current-room').textContent = roomNames[roomId];
        }

        // Clear turret
        function clearTurret() {
            if (confirm('Send all players from Turret to Lobby?')) {
                database.ref('players').once('value', (snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        const player = childSnapshot.val();
                        if (player.room === 'turret') {
                            database.ref('players/' + childSnapshot.key + '/room').set('lobby');
                            database.ref('players/' + childSnapshot.key + '/turretInvited').set(false);
                        }
                    });
                });
            }
        }

        // Update turret list
        function updateTurretPlayersList() {
            database.ref('players').on('value', (snapshot) => {
                const turretPlayers = [];
                snapshot.forEach((childSnapshot) => {
                    const player = childSnapshot.val();
                    if (player.room === 'turret' && !player.isHost) {
                        turretPlayers.push(player.name);
                    }
                });
                
                const listDiv = document.getElementById('turret-players-list');
                if (turretPlayers.length === 0) {
                    listDiv.textContent = 'None';
                } else {
                    listDiv.innerHTML = turretPlayers.map(name => `<div>â€¢ ${name}</div>`).join('');
                }
            });
        }

        // Update room player lists
        function updateRoomPlayerLists() {
            const rooms = ['main', 'kitchen', 'library', 'living', 'courtyard', 'bathroom', 'gym', 'turret'];
            
            database.ref('players').on('value', (snapshot) => {
                // Count players per room
                const roomCounts = {};
                const roomPlayers = {};
                
                rooms.forEach(room => {
                    roomCounts[room] = 0;
                    roomPlayers[room] = [];
                });
                
                snapshot.forEach((childSnapshot) => {
                    const player = childSnapshot.val();
                    if (player.room && roomCounts.hasOwnProperty(player.room) && player.status !== 'ghost') {
                        roomCounts[player.room]++;
                        roomPlayers[player.room].push(player.name);
                    }
                });
                
                // Update counts and player lists
                database.ref('game/roomLimits').once('value', (limitsSnapshot) => {
                    const limits = limitsSnapshot.val() || {};
                    
                    rooms.forEach(room => {
                        const countEl = document.getElementById(`host-count-${room}`);
                        const playersEl = document.getElementById(`players-${room}`);
                        
                        if (countEl) {
                            const limit = limits[room] || 24;
                            countEl.textContent = `${roomCounts[room]}/${limit}`;
                        }
                        
                        if (playersEl) {
                            if (roomPlayers[room].length === 0) {
                                playersEl.innerHTML = '<div style="color: #666;">Empty</div>';
                            } else {
                                playersEl.innerHTML = roomPlayers[room].map(name => 
                                    `<div>â€¢ ${name}</div>`
                                ).join('');
                            }
                        }
                    });
                });
            });
        }

        // Initialize room player lists
        updateRoomPlayerLists();

        // Initialize turret list updates
        updateTurretPlayersList();
    </script>
</body>
</html>
