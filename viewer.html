<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer - Subversion: The Traitors</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-interface">
        <!-- Top Bar with Timer -->
        <div class="top-bar">
            <div class="viewer-info">
                <span>üëÅÔ∏è Viewer: <span id="viewer-name-display"></span></span>
            </div>

            <div class="timer-display">
                <div class="phase-name" id="phase-name">Waiting to Start</div>
                <div class="timer" id="timer">00:00</div>
            </div>

            <div style="width: 200px;"></div> <!-- Spacer for alignment -->
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Video Circle -->
            <div class="video-circle-container">
                <div class="video-circle" id="video-circle">
                    <!-- Seat 1 (Host) - Top Left -->
                    <div class="video-seat host" id="seat-1">
                        <div id="video-1"></div>
                        <div class="seat-label">
                            <span class="seat-number">Seat 1</span>
                            <span class="player-name" id="name-1">Host</span>
                        </div>
                    </div>

                    <!-- Player Seats 2-25 will be generated by JavaScript -->
                </div>

                <!-- Current Room Display -->
                <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); padding: 10px 20px; border-radius: 8px; font-weight: bold;">
                    Viewing: <span id="current-room-display">Main Roundtable</span>
                </div>
            </div>

            <!-- Room Selection Panel -->
            <div class="room-panel" id="room-panel" style="display: block;">
                <h3>Switch Room</h3>
                <div class="room-list">
                    <div class="room-item" onclick="switchViewerRoom('main')">
                        <div class="room-name">Main Roundtable</div>
                        <div class="room-count" id="count-main">0/24</div>
                    </div>
                    <div class="room-item" onclick="switchViewerRoom('kitchen')">
                        <div class="room-name">Kitchen</div>
                        <div class="room-count" id="count-kitchen">0/5</div>
                    </div>
                    <div class="room-item" onclick="switchViewerRoom('library')">
                        <div class="room-name">Library</div>
                        <div class="room-count" id="count-library">0/5</div>
                    </div>
                    <div class="room-item" onclick="switchViewerRoom('living')">
                        <div class="room-name">Living Room</div>
                        <div class="room-count" id="count-living">0/5</div>
                    </div>
                    <div class="room-item" onclick="switchViewerRoom('courtyard')">
                        <div class="room-name">Courtyard</div>
                        <div class="room-count" id="count-courtyard">0/5</div>
                    </div>
                    <div class="room-item" onclick="switchViewerRoom('bathroom')">
                        <div class="room-name">Bathroom</div>
                        <div class="room-count" id="count-bathroom">0/3</div>
                    </div>
                    <div class="room-item" onclick="switchViewerRoom('gym')">
                        <div class="room-name">Gym</div>
                        <div class="room-count" id="count-gym">0/5</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Night Overlay -->
    <div class="overlay-screen" id="night-overlay">
        <div class="overlay-message">The Traitors Are Meeting In The Turret...</div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <!-- Game Logic -->
    <script src="game.js"></script>
    <script src="video-placeholder.js"></script>

    <!-- Viewer-Specific Logic -->
    <script>
        // Check if user is authorized
        if (sessionStorage.getItem('userRole') !== 'viewer') {
            alert('Unauthorized access');
            window.location.href = 'index.html';
        }

        // Display viewer name
        const viewerName = sessionStorage.getItem('viewerName');
        document.getElementById('viewer-name-display').textContent = viewerName || 'Anonymous';

        // Current viewing room
        let currentViewingRoom = 'main';

        function switchViewerRoom(roomId) {
            currentViewingRoom = roomId;
            
            const roomNames = {
                'main': 'Main Roundtable',
                'kitchen': 'Kitchen',
                'library': 'Library',
                'living': 'Living Room',
                'courtyard': 'Courtyard',
                'bathroom': 'Bathroom',
                'gym': 'Gym'
            };
            
            document.getElementById('current-room-display').textContent = roomNames[roomId];
            
            // Update which players are visible based on room
            updateViewerDisplay();
        }

        function updateViewerDisplay() {
            // Show/hide players based on which room they're in
            for (let i = 1; i <= 25; i++) {
                const seatElement = document.getElementById(`seat-${i}`);
                if (!seatElement) continue;
                
                // Find player in this seat
                let playerInSeat = null;
                for (let playerId in gameState.players) {
                    const player = gameState.players[playerId];
                    if (player.seat === i) {
                        playerInSeat = player;
                        break;
                    }
                }
                
                if (playerInSeat) {
                    // Show if in current viewing room, hide otherwise
                    if (playerInSeat.room === currentViewingRoom) {
                        seatElement.style.opacity = '1';
                    } else {
                        seatElement.style.opacity = '0.3';
                    }
                }
            }
        }

        // Update room counts
        database.ref('players').on('value', (snapshot) => {
            const counts = {
                main: 0,
                kitchen: 0,
                library: 0,
                living: 0,
                courtyard: 0,
                bathroom: 0,
                gym: 0
            };
            
            snapshot.forEach((child) => {
                const player = child.val();
                if (player.room && counts.hasOwnProperty(player.room)) {
                    counts[player.room]++;
                }
            });
            
            // Update room limits
            database.ref('game/roomLimits').once('value', (limitsSnapshot) => {
                const limits = limitsSnapshot.val() || {};
                
                document.getElementById('count-main').textContent = `${counts.main}/${limits.main || 24}`;
                document.getElementById('count-kitchen').textContent = `${counts.kitchen}/${limits.kitchen || 5}`;
                document.getElementById('count-library').textContent = `${counts.library}/${limits.library || 5}`;
                document.getElementById('count-living').textContent = `${counts.living}/${limits.living || 5}`;
                document.getElementById('count-courtyard').textContent = `${counts.courtyard}/${limits.courtyard || 5}`;
                document.getElementById('count-bathroom').textContent = `${counts.bathroom}/${limits.bathroom || 3}`;
                document.getElementById('count-gym').textContent = `${counts.gym}/${limits.gym || 5}`;
            });
            
            updateViewerDisplay();
        });
    </script>
</body>
</html>
